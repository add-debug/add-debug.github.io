<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Quiz com API</title>
  <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
  <style>
body {
  font-family: 'Segoe UI', sans-serif;
  background: linear-gradient(to right, #ffe4e9, #fff0f5);
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
  margin: 0;
}

.quiz-box {
  background: white;
  padding: 25px;
  border: 2px solid #ff99aa;
  border-radius: 15px;
  box-shadow: 0 8px 16px rgba(0,0,0,0.1);
  max-width: 500px;
  width: 100%;
  transition: transform 0.3s ease;
  text-align: center;
}

.quiz-box:hover {
  transform: scale(1.01);
}

h1 {
  font-family: 'Pacifico', cursive;
  font-style: italic;
  font-size: 32px;
  color: #cc3366;
  margin-bottom: 5px;
}

h2 {
  color: #cc3366;
  font-size: 26px;
  margin-bottom: 10px;
}

#pergunta {
  margin: 20px 0 10px;
  font-size: 18px;
  color: #444;
}

.opcao-btn {
  display: block;
  margin: 8px 0;
  padding: 10px;
  border: none;
  border-radius: 8px;
  width: 100%;
  cursor: pointer;
  background: #0077cc;
  color: white;
  font-size: 16px;
  transition: background 0.3s ease, transform 0.2s ease;
}

.opcao-btn:hover {
  background: #005fa3;
  transform: scale(1.02);
}

.btn-vermelho {
  background: #cc0000;
  margin-top: 20px;
}

.btn-vermelho:hover {
  background: #990000;
}

#resultado {
  margin-top: 15px;
  font-weight: bold;
  text-align: center;
  font-size: 17px;
  color: #333;
}

#contador {
  margin-top: 15px;
  text-align: center;
  font-size: 17px;
  color: #555;
}

.pulso {
  animation: pulso 0.6s ease;
}

@keyframes pulso {
  0% { transform: scale(1); color: #555; }
  50% { transform: scale(1.3); color: #cc3366; }
  100% { transform: scale(1); color: #555; }
}
#resetBtn {
  background: #ffcc00;
  color: #333;
  margin-top: 10px;
}

#resetBtn:hover {
  background: #e6b800;
}
#timer {
  font-size: 16px;
  color: #cc3366;
  text-align: center;
  margin-top: 10px;
}

  </style>
</head>
<body>
  <div class="quiz-box">
    <h1>Control+Quiz</h1>
    <p id="timer">‚è±Ô∏è Tempo restante: 15s</p>
    <button class="opcao-btn" id="iniciarBtn">Iniciar Quiz</button>
	<button class="opcao-btn" id="reiniciarBtn" style="display:none;">üîÅ Reiniciar Quiz</button>
	<button class="opcao-btn" id="voltarBtn" style="display:none;">üè† Voltar √† Tela Inicial</button>
	
    <p id="pergunta" style="display:none;">Carregando pergunta...</p>
    <div id="opcoes"></div>
    <button class="opcao-btn btn-vermelho" id="novoBtn" style="display:none;">Nova Pergunta</button>
	<button class="opcao-btn btn-vermelho" id="resetBtn">üîÑ Resetar Quiz</button>
    <p id="resultado"></p>
    <div id="contador" style="display:none;">
      <span id="acertosContador">‚úÖ Acertos: 0</span> |
      <span id="errosContador">‚ùå Erros: 0</span>
    </div>
  </div>

  <script>
const perguntasUsadas = new Set();
let acertos = 0;
let erros = 0;
let totalPerguntas = 0;
const limitePerguntas = 20;
let tempoRestante = 15;
let intervaloTimer;

// --- Listeners de Bot√µes ---
document.getElementById("iniciarBtn").addEventListener("click", () => {
    document.getElementById("iniciarBtn").style.display = "none";
    document.getElementById("reiniciarBtn").style.display = "none";
    document.getElementById("voltarBtn").style.display = "none";
    document.getElementById("pergunta").style.display = "block";
    document.getElementById("novoBtn").style.display = "inline-block";
    document.getElementById("contador").style.display = "block";
    perguntasUsadas.clear(); // Limpa perguntas usadas ao iniciar
    carregarPergunta();
});

document.getElementById("novoBtn").addEventListener("click", () => {
    if (totalPerguntas < limitePerguntas) {
        carregarPergunta();
    }
});

document.getElementById("reiniciarBtn").addEventListener("click", reiniciarQuiz);
document.getElementById("voltarBtn").addEventListener("click", voltarInicio);
document.getElementById("resetBtn").addEventListener("click", resetarQuiz);

// --- Fun√ß√µes Auxiliares ---

function decodeHtml(html) {
    const txt = document.createElement("textarea");
    txt.innerHTML = html;
    return txt.value;
}

function atualizarTimer() {
    document.getElementById("timer").innerText = `‚è±Ô∏è Tempo restante: ${tempoRestante}s`;
}

function atualizarContadores(id) {
    document.getElementById("acertosContador").innerText = `‚úÖ Acertos: ${acertos}`;
    document.getElementById("errosContador").innerText = `‚ùå Erros: ${erros}`;

    if (id) {
        const el = document.getElementById(id);
        el.classList.remove("pulso");
        void el.offsetWidth; // For√ßa o reflow para reiniciar a anima√ß√£o
        el.classList.add("pulso");
    }
}

// --- Fun√ß√µes de Controle do Quiz ---

async function carregarPergunta() {
    // 1. Resetar Timer
    clearInterval(intervaloTimer);
    tempoRestante = 15;
    atualizarTimer();
    document.getElementById("resultado").innerText = "";

    // 2. Iniciar Timer
    intervaloTimer = setInterval(() => {
        tempoRestante--;
        atualizarTimer();

        if (tempoRestante <= 0) {
            clearInterval(intervaloTimer);
            // Verifica se a pergunta ainda est√° sendo exibida antes de contar o erro
            if (document.getElementById("opcoes").children.length > 0) {
                totalPerguntas++;
                erros++;
                document.getElementById("resultado").innerHTML = "‚è∞ Tempo esgotado!";
                atualizarContadores("errosContador");
                document.getElementById("opcoes").innerHTML = ""; // Desativa op√ß√µes
                
                if (totalPerguntas >= limitePerguntas) {
                    encerrarQuiz();
                }
            }
        }
    }, 1000);

    // 3. Buscar Pergunta
    document.getElementById("pergunta").innerText = "Carregando pergunta...";
    document.getElementById("opcoes").innerHTML = "";

    let perguntaObj;
    let tentativa = 0;
    let perguntaUnicaEncontrada = false;

    // Tenta buscar uma pergunta n√£o repetida
    while (!perguntaUnicaEncontrada && tentativa < 5) {
        try {
            // Nova API OpenTDB (ajustada para amount=1 para carregar uma por vez)
            const resposta = await fetch(`https://opentdb.com/api.php?amount=1&encode=base64&nocache=${Date.now()}`);
            const dados = await resposta.json();

            if (!dados || !dados.results || dados.results.length === 0) {
                document.getElementById("pergunta").innerText = "N√£o foi poss√≠vel carregar pergunta.";
                clearInterval(intervaloTimer);
                return;
            }
            
            // Decodifica a pergunta, pois usamos 'encode=base64' para evitar problemas de caracteres
            perguntaObj = dados.results[0];
            perguntaObj.question = decodeHtml(atob(perguntaObj.question));
            perguntaObj.correct_answer = decodeHtml(atob(perguntaObj.correct_answer));
            perguntaObj.incorrect_answers = perguntaObj.incorrect_answers.map(ans => decodeHtml(atob(ans)));

            if (!perguntasUsadas.has(perguntaObj.question)) {
                perguntasUsadas.add(perguntaObj.question);
                perguntaUnicaEncontrada = true;
            }
            tentativa++;
        } catch (erro) {
            console.error("Erro ao buscar API:", erro);
            document.getElementById("pergunta").innerText = "Erro ao carregar pergunta.";
            clearInterval(intervaloTimer);
            return;
        }
    }

    if (!perguntaObj) return; // Se falhou em 5 tentativas

    document.getElementById("pergunta").innerHTML = perguntaObj.question;

    // 4. Exibir Op√ß√µes
    let opcoes = [...perguntaObj.incorrect_answers, perguntaObj.correct_answer];
    opcoes.sort(() => Math.random() - 0.5);

    const opcoesDiv = document.getElementById("opcoes");
    opcoes.forEach(op => {
        const btn = document.createElement("button");
        btn.className = "opcao-btn";
        btn.innerText = op;
        btn.onclick = () => {
            // Desativar todos os bot√µes ap√≥s a sele√ß√£o para evitar cliques m√∫ltiplos
            Array.from(opcoesDiv.children).forEach(button => button.disabled = true);
            
            clearInterval(intervaloTimer);
            totalPerguntas++;
            
            if (op === perguntaObj.correct_answer) {
                acertos++;
                document.getElementById("resultado").innerHTML = `‚úÖ Acertou!`;
                btn.style.backgroundColor = '#4CAF50'; // Verde
                atualizarContadores("acertosContador");
            } else {
                erros++;
                document.getElementById("resultado").innerHTML =
                    `‚ùå Errou!<br>Resposta certa: ${perguntaObj.correct_answer}`;
                btn.style.backgroundColor = '#F44336'; // Vermelho para a errada
                // Destaca a resposta correta
                Array.from(opcoesDiv.children).find(b => b.innerText === perguntaObj.correct_answer).style.backgroundColor = '#4CAF50';
                atualizarContadores("errosContador");
            }

            if (totalPerguntas >= limitePerguntas) {
                encerrarQuiz();
            }
        };
        opcoesDiv.appendChild(btn);
    });
}

function encerrarQuiz() {
    clearInterval(intervaloTimer);
    document.getElementById("pergunta").innerText = `üéâ Quiz Finalizado! Voc√™ acertou ${acertos} de ${limitePerguntas} perguntas.`;
    document.getElementById("opcoes").innerHTML = "";
    document.getElementById("novoBtn").style.display = "none";
    document.getElementById("reiniciarBtn").style.display = "inline-block";
    document.getElementById("voltarBtn").style.display = "inline-block";
}

function reiniciarQuiz() {
    acertos = 0;
    erros = 0;
    totalPerguntas = 0;
    perguntasUsadas.clear();
    clearInterval(intervaloTimer);

    document.getElementById("reiniciarBtn").style.display = "none";
    document.getElementById("voltarBtn").style.display = "none";
    document.getElementById("resultado").innerText = "";
    atualizarContadores();
    carregarPergunta();
    document.getElementById("novoBtn").style.display = "inline-block";
}

function voltarInicio() {
    location.reload(); // Recarrega a p√°gina para voltar ao estado inicial
}

function resetarQuiz() {
    clearInterval(intervaloTimer);
    acertos = 0;
    erros = 0;
    totalPerguntas = 0;
    perguntasUsadas.clear();

    document.getElementById("resultado").innerText = "";
    document.getElementById("opcoes").innerHTML = "";
    document.getElementById("pergunta").style.display = "none";
    document.getElementById("contador").style.display = "none";
    document.getElementById("novoBtn").style.display = "none";
    document.getElementById("reiniciarBtn").style.display = "none";
    document.getElementById("voltarBtn").style.display = "none";
    document.getElementById("iniciarBtn").style.display = "inline-block";
    
    // Reseta o timer visualmente para o in√≠cio
    tempoRestante = 15;
    atualizarTimer();
    atualizarContadores();
    document.getElementById("pergunta").innerText = "Carregando pergunta...";
}
</script>
</body>
</html>
